/*===========================================================================*=
   CFP - Technique - Primitives (implémentation d'une communication HID 
   Auteur        : Silicon Laboratories, Inc.
   Adaption      : Neuhaus J.  
   Date création : 13 avril 2010
   Modifié le    : 20 juin 2010 - 15:28
   Version       : 1.0
  =============================================================================
   Descriptif: Exploitation du bus USB en version HID (mode interrupt) 
			      Dérivé du firmware pour le kit 8051F320, copyright 2005 
			      Silicon Laboratories, Inc. (http://www.silabs.com)
   
			      Release 1.3
    
               Communication via 2 Pipes (In & Out) en mode interrupt.
   			   Dispositif HID propriétaire.
   
   			   USAGE simple composé d'une paquet de données de 64 bytes en 
   			   sortie est d'un paquet 64 bytes en entrée.
   
   			   L'interruption de l'usb est bloquée pendant l'actualisation 
   			   des buffers afin de maintenir la cohérence des données dans 
   			   la trame.		   
=*===========================================================================*/

//--- Includes ----------------------------------------------------------------
#include <c8051f320.h>

#include "F32x_USB_Primitives.h"
#include "F32x_USB_Register.h"

//--- Prototypes fonctions
void Delay();

//--- Buffer de données de l'application
xdata BYTE ReceiveDataBuffer[EP2_PACKET_SIZE];  // Buffer données reçues
xdata BYTE SendDataBuffer[EP1_PACKET_SIZE];     // Buffer données à envoyer

//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%//
//	      ROUTINES D'INITIALISATION SYSTEME POUR USB issues du firmware       //
//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%//

/*---------------------------------------------------------------------------*-
   Write_send_Packet ()
  -----------------------------------------------------------------------------
   Descriptif: Copie les données à transmettre dans le buffer de transmission 
   Entrée    : ptrData, pointeur sur le buffer de données de l'application
               size, taille du buffer 
   Sortie    : --
-*---------------------------------------------------------------------------*/
void Write_send_Packet (char *ptrData, unsigned int size) 
{
   //--- Variables locales ----------------------------------------------------
   int i;
   //--------------------------------------------------------------------------

   EIE1 &= ~EUSB0;    //Verrouille l'USB pendant l'actualisation des données

   //Copie les données dans le buffer de transmission
   for(i=0; i<size; i++)
     In_Packet[i] = *(ptrData + i);

   EIE1 |= EUSB0;    //Libère l'USB 

} // Write_send_Packet --------------------------------------------------------

/*---------------------------------------------------------------------------*-
   Read_receive_Packet ()
  -----------------------------------------------------------------------------
   Descriptif: Copie les données à reçues du buffer de réception 
   Entrée    : ptrData, pointeur sur le buffer de données de l'application
               size, taille du buffer 
   Sortie    : --
-*---------------------------------------------------------------------------*/
void Read_receive_Packet (char *ptrData, unsigned int size) 
{
   //--- Variables locales ----------------------------------------------------
   int i;
   //--------------------------------------------------------------------------

   EIE1 &= ~EUSB0;    //Verrouille l'USB pendant l'actualisation des données

   //Copie les données du buffer de réception
   for(i=0; i<size; i++)
     *(ptrData + i) = Out_Packet[i];

   EIE1 |= EUSB0;    //Libère l'USB 

} // Read_receive_Packet ------------------------------------------------------

//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%//
//	      ROUTINES D'INITIALISATION SYSTEME POUR USB issues du firmware       //
//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%//

/*---------------------------------------------------------------------------*-
   Sysclk_Init ()
  -----------------------------------------------------------------------------
   Descriptif: Initialisation du clock système & usb 
   Entrée    : --
   Sortie    : --
-*---------------------------------------------------------------------------*/
void Sysclk_Init()
{
#ifdef _USB_LOW_SPEED_

   OSCICN |= 0x03;                     // Configure internal oscillator for
                                       // its maximum frequency and enable
                                       // missing clock detector

   CLKSEL  = SYS_INT_OSC;              // Select System clock
   CLKSEL |= USB_INT_OSC_DIV_2;        // Select USB clock
#else
   OSCICN |= 0x03;                     // Configure internal oscillator for
                                       // its maximum frequency and enable
                                       // missing clock detector

   CLKMUL  = 0x00;                     // Select internal oscillator as
                                       // input to clock multiplier

   CLKMUL |= 0x80;                     // Enable clock multiplier
   Delay();                            // Delay for clock multiplier to begin
   CLKMUL |= 0xC0;                     // Initialize the clock multiplier
   Delay();                            // Delay for clock multiplier to begin

   while(!(CLKMUL & 0x20));            // Wait for multiplier to lock
//   CLKSEL  = SYS_INT_OSC;              // Select system clock

   CLKSEL  = SYS_4X_DIV_2;             // Select system clock		<-- Tuned
   CLKSEL |= USB_4X_CLOCK;             // Select USB clock
#endif  /* _USB_LOW_SPEED_ */

} // Sysclk_Init --------------------------------------------------------------

/*---------------------------------------------------------------------------*-
   Usb0_Init ()
  -----------------------------------------------------------------------------
   Descriptif: Initialisation de l'USB0
				- USB0 interrupts autorisé
				- USB0 transceiver autorisé
				- USB0 avec détection du mode suspendu autorisé     
   Entrée    : --
   Sortie    : --
-*---------------------------------------------------------------------------*/
void Usb0_Init()
{
   BYTE Count;

   // Set initial values of In_Packet and Out_Packet to zero
   // Initialized here so that WDT doesn't kick in first
   for (Count = 0; Count < 64; Count++)
   {
      Out_Packet[Count] = 0;
      In_Packet[Count] = 0;
   }

   POLL_WRITE_BYTE(POWER,  0x08);      // Force Asynchronous USB Reset
   POLL_WRITE_BYTE(IN1IE,  0x07);      // Enable Endpoint 0-2 in interrupts
   POLL_WRITE_BYTE(OUT1IE, 0x07);      // Enable Endpoint 0-2 out interrupts
   POLL_WRITE_BYTE(CMIE,   0x07);      // Enable Reset,Resume,Suspend interrupts

#ifdef _USB_LOW_SPEED_
   USB0XCN = 0xC0;                     // Enable transceiver; select low speed
   POLL_WRITE_BYTE(CLKREC, 0xA0);      // Enable clock recovery; single-step mode
                                        // disabled; low speed mode enabled
#else
   USB0XCN = 0xE0;                     // Enable transceiver; select full speed
   POLL_WRITE_BYTE(CLKREC, 0x80);      // Enable clock recovery, single-step mode
                                       // disabled
#endif // _USB_LOW_SPEED_

   EIE1 |= 0x02;                       // Enable USB0 Interrupts
   EA = 1;                             // Global Interrupt enable
                                       // Enable USB0 by clearing the USB 
                                       // Inhibit bit
   POLL_WRITE_BYTE(POWER,  0x01);      // and enable suspend detection
} // Usb0_Init ----------------------------------------------------------------

/*---------------------------------------------------------------------------*-
   Delay ()
  -----------------------------------------------------------------------------
   Descriptif: Delay pour les phases d'initialisation de l'usb 
                 ~80us en full speed
                 ~1ms  en low speed
   Entrée    : --
   Sortie    : --
-*---------------------------------------------------------------------------*/
void Delay()
{
   //--- Variables locales ----------------------------------------------------
   int x;
   //--------------------------------------------------------------------------

   for(x = 0;x < 500;x) x++;

} // Delay --------------------------------------------------------------------



